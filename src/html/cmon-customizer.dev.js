const cartItems = [
    {
        'id': 77,
        'value': {
            "id": 49,
            "code": "PAC_MUG2",
            "previews": [
                {
                    "fond": 361,
                    "forme": 15,
                    "font": 14,
                    "picto": null,
                    "textcolor": 140,
                    "textes": [
                        {
                            "value": "test",
                            "ratio": 0.74
                        }
                    ],
                    "pack": {
                        "name": "products.PAC_MUG2.name",
                        "item": "MUG",
                        "qty": 1,
                        "description": "options.forme.names.MUG",
                        "variation": "options.forme.variations.NONE"
                    }
                },
                {
                    "fond": 256,
                    "forme": 21,
                    "font": null,
                    "picto": 0,
                    "textcolor": null,
                    "textes": [],
                    "pack": {
                        "name": "products.PAC_MUG2.name",
                        "item": "SAC",
                        "qty": 1,
                        "description": "options.forme.names.SAC",
                        "variation": "options.forme.variations.NONE"
                    }
                },
                {
                    "fond": 432,
                    "forme": 40,
                    "font": null,
                    "picto": 0,
                    "textcolor": null,
                    "textes": [],
                    "pack": {
                        "name": "products.PAC_MUG2.name",
                        "item": "CPL",
                        "qty": 1,
                        "description": "options.forme.names.CPL",
                        "variation": "options.forme.variations.OOK"
                    }
                }
            ]
        }
    },
    {
        'id': 76,
        'value': {
            "id": 47,
            "code": "VAR_STI",
            "previews": [
                {
                    "fond": 423,
                    "forme": 38,
                    "font": null,
                    "picto": null,
                    "textcolor": null,
                    "textes": [],
                    "pack": null
                }
            ]
        }
    },
    {
        'id': 75,
        'value': {
            "id": 33,
            "code": "OBJ_CHA",
            "previews": [
                {
                    "fond": 343,
                    "forme": 30,
                    "font": 13,
                    "picto": null,
                    "textcolor": 119,
                    "textes": [
                        {
                            "value": "Camille Groult",
                            "ratio": 0.76
                        }
                    ],
                    "pack": null
                }
            ]
        }
    },
    {
        'id': 74,
        'value': {
            "id": 40,
            "code": "OBJ_SAC2",
            "previews": [
                {
                    "fond": 354,
                    "forme": 31,
                    "font": 12,
                    "picto": null,
                    "textcolor": 132,
                    "textes": [
                        {
                            "value": "Jean-Patrick Bateman",
                            "ratio": 0.76
                        }
                    ],
                    "pack": null
                }
            ]
        }
    },
    {
        'id': 73,
        'value': {
            "id": 41,
            "code": "OBJ_TRO2",
            "previews": [
                {
                    "fond": 382,
                    "forme": 35,
                    "font": 12,
                    "picto": null,
                    "textcolor": 173,
                    "textes": [
                        {
                            "value": "Test avec un texte loooong",
                            "ratio": 0.87
                        }
                    ],
                    "pack": null
                }
            ]
        }
    },
    {
        'id': 72,
        'value': {
            "id": 41,
            "code": "OBJ_TRO2",
            "previews": [
                {
                    "fond": 379,
                    "forme": 34,
                    "font": 13,
                    "picto": null,
                    "textcolor": 177,
                    "textes": [
                        {
                            "value": "Test avec u",
                            "ratio": 1.01
                        }
                    ],
                    "pack": null
                }
            ]
        }
    },
    {
        'id': 71,
        'value': {
            "id": 41,
            "code": "OBJ_TRO2",
            "previews": [
                {
                    "fond": 379,
                    "forme": 34,
                    "font": 13,
                    "picto": null,
                    "textcolor": 177,
                    "textes": [
                        {
                            "value": "Test avec un texte loooong",
                            "ratio": 0.75
                        }
                    ],
                    "pack": null
                }
            ]
        }
    },
    {
        'id': 70,
        'value': {
            "id": 39,
            "code": "OBJ_TRO",
            "previews": [
                {
                    "fond": 377,
                    "forme": 32,
                    "font": 12,
                    "picto": null,
                    "textcolor": 160,
                    "textes": [
                        {
                            "value": "Nicolas Gans",
                            "ratio": 0.7
                        }
                    ],
                    "pack": null
                }
            ]
        }
    },
    {
        'id': 69,
        'value':{
            "id": 34,
            "code": "OBJ_MUG2",
            "previews": [
                {
                    "fond": 347,
                    "forme": 18,
                    "font": null,
                    "picto": null,
                    "textcolor": null,
                    "textes": [],
                    "pack": null
                }
            ]
        }
    },
    {
        'id': 68,
        'value': {
            "id": 16,
            "code": "SMP_BOU",
            "previews": [
                {
                    "fond": 294,
                    "forme": 19,
                    "font": null,
                    "picto": null,
                    "textcolor": null,
                    "textes": [],
                    "pack": null
                }
            ]
        }
    },
    // {
    //     'id': 66,
    //     'value': {
    //         "id": 21,
    //         "code": "SMP_BOI",
    //         "previews": [
    //             {
    //                 "fond": 337,
    //                 "forme": 24,
    //                 "font": null,
    //                 "picto": null,
    //                 "textcolor": null,
    //                 "textes": [],
    //                 "pack": null
    //             }
    //         ]
    //     }
    // },
    {
        'id': 65,
        'value': {
            "id": 18,
            "code": "SMP_AFF",
            "previews": [
                {
                    "fond": 249,
                    "forme": 22,
                    "font": null,
                    "picto": null,
                    "textcolor": null,
                    "textes": [],
                    "pack": null
                }
            ]
        }
    },
    {
        'id': 64,
        'value': {
            "id": 7,
            "code": "VAR_MAR",
            "previews": [
                {
                    "fond": 267,
                    "forme": 7,
                    "font": 1,
                    "picto": 325,
                    "textcolor": 35,
                    "textes": [
                        {
                            "value": "mon super texte ",
                            "ratio": 0.55
                        },
                        {
                            "value": "un peu long pour",
                            "ratio": 0.5
                        }
                    ],
                    "pack": null
                }
            ]
        }
    },
    {
        'id': 63,
        'value': {
            "id": 7,
            "code": "VAR_MAR",
            "previews": [
                {
                    "fond": 267,
                    "forme": 6,
                    "font": 1,
                    "picto": 388,
                    "textcolor": 35,
                    "textes": [
                        {
                            "value": "mon super texte un peu",
                            "ratio": 0.87
                        }
                    ],
                    "pack": null
                }
            ]
        }
    },
    {
        'id': 62,
        'value': {
            "id": 2,
            "code": "VAR_EAV",
            "previews": [
                {
                    "fond": 265,
                    "forme": 8,
                    "font": 1,
                    "picto": 325,
                    "textcolor": 12,
                    "textes": [
                        {
                            "value": "Mon super texte",
                            "ratio": 0.8
                        },
                        {
                            "value": "un peu long pour",
                            "ratio": 0.7
                        }
                    ],
                    "pack": null
                }
            ]
        }
    },
    {
      'id': 61,
      'value': {
          "id": 7,
          "code": "VAR_MAR",
          "previews": [
              {
                  "fond": 267,
                  "forme": 5,
                  "font": 1,
                  "picto": 388,
                  "textcolor": 35,
                  "textes": [
                      {
                          "value": "Mon super texte un peu",
                          "ratio": 0.65
                      },
                      {
                          "value": "long car je dois teste",
                          "ratio": 0.75
                      },
                      {
                          "value": "si ça rentre et si ça ",
                          "ratio": 0.8
                      },
                      {
                          "value": "a un bon rendu en peti",
                          "ratio": 0.65
                      }
                  ],
                  "pack": null
              }
          ]
      }
    },
    {
        'id': 60,
        'value': {
            "id": 1,
            "code": "VAR_ETV",
            "previews": [
                {
                    "fond": 277,
                    "forme": 2,
                    "font": 13,
                    "picto": 318,
                    "textcolor": 28,
                    "textes": [
                        {
                            "value": "Mon super texte une pe",
                            "ratio": 0.85
                        },
                        {
                            "value": "u lon gpour tester les",
                            "ratio": 0.85
                        }
                    ],
                    "pack": null
                }
            ]
        }
    },
    {
        'id': 44,
        'value':{
            'id': 3,
            'code': 'VAR_EAO',
            'previews': [
                {
                    'fond': 292,
                    'forme': 3,
                    'font': 12,
                    'picto': 372,
                    'textcolor': 15,
                    'textes': [
                        {
                            'value': 'dqdqddqdqs',
                            'ratio': 1
                        }
                    ],
                    'pack': null
                }
            ]
        }
    },
    {
        'id': 42,
        'value': {
            'id': 6,
            'code': 'VAR_BAP',
            'previews': [
                {
                    'fond': 96,
                    'forme': 7,
                    'font': 17,
                    'picto': 331,
                    'textcolor': 36,
                    'textes': [
                        {
                            'value': 'Robert Fait un',
                            'ratio': 0.9
                        },
                        {
                            'value': 'petit test',
                            'ratio': 1
                        }
                    ],
                    'pack': null
                }
            ]
        }
    },
    {
        'id': 46,
        'value': {
            'id': 14,
            'code': 'OBJ_BOX',
            'previews': [
                {
                    'fond': 295,
                    'forme': 13,
                    'font': 13,
                    'picto': 105,
                    'textcolor': 89,
                    'textes': [
                        {
                            'value': 'Nicolas Gans est f',
                            'ratio': 0.85
                        }
                    ],
                    'pack': null
                }
            ]
        }
    },
    {
        'id': 45,
        'value': {
            'id': 13,
            'code': 'OBJ_GRD',
            'previews': [
                {
                    'fond': 296,
                    'forme': 9,
                    'font': 13,
                    'picto': 105,
                    'textcolor': 56,
                    'textes': [
                        {
                            'value': 'Nicolas Gans est fatigué',
                            'ratio': 0.61
                        }
                    ],
                    'pack': null
                }
            ]
        }
    },
    {
        'id': 47,
        'value': {
            'id': 13,
            'code': 'OBJ_GRD',
            'previews': [
                {
                    'fond': 295,
                    'forme': 9,
                    'font': 1,
                    'picto': 105,
                    'textcolor': 89,
                    'textes': [
                        {
                            'value': 'Nicolas Gans est fatigué',
                            'ratio': 0.48
                        }
                    ],
                    'pack': null
                }
            ]
        }
    },
    {
        'id': 67,
        'value': {
            'id': 13,
            'code': 'OBJ_GRD',
            'previews': [
                {
                    'fond': 171,
                    'forme': 9,
                    'font': 13,
                    'picto': 105,
                    'textcolor': 38,
                    'textes': [
                        {
                            'value': 'Nicolas Gans',
                            'ratio': 0.97
                        }
                    ],
                    'pack': null
                }
            ]
        }
    },
    {
        'id': 41,
        'value': {
            'id': 15,
            'code': 'OBJ_MUG',
            'previews': [
                {
                    'fond': 298,
                    'forme': 14,
                    'font': 13,
                    'picto': 105,
                    'textcolor': 90,
                    'textes': [
                        {
                            'value': 'Back in black !?!',
                            'ratio': 0.93
                        }
                    ],
                    'pack': null
                }
            ]
        }
    },
    {
        'id': 49,
        'value': {
            'id': 15,
            'code': 'OBJ_MUG',
            'previews': [
                {
                    'fond': 304,
                    'forme': 14,
                    'font': 10,
                    'picto': 105,
                    'textcolor': 47,
                    'textes': [
                        {
                            'value': 'Nicolas Gans est formida',
                            'ratio': 0.67
                        }
                    ],
                    'pack': null
                }
            ]
        }
    },
    {
        'id': 50,
        'value': {
            'id': 15,
            'code': 'OBJ_MUG',
            'previews': [
                {
                    'fond': 296,
                    'forme': 14,
                    'font': 13,
                    'picto': 105,
                    'textcolor': 56,
                    'textes': [
                        {
                            'value': 'Je suis un licorne rose',
                            'ratio': 0.67
                        }
                    ],
                    'pack': null
                }
            ]
        }
    },
    {
        'id': 51,
        'value': {
            'id': 15,
            'code': 'OBJ_MUG',
            'previews': [
                {
                    'fond': 299,
                    'forme': 14,
                    'font': 1,
                    'picto': 105,
                    'textcolor': 94,
                    'textes': [
                        {
                            'value': 'SUPER PAPA',
                            'ratio': 1
                        }
                    ],
                    'pack': null
                }
            ]
        }
    },
    {
        'id': 43,
        'value': {
            'id': 12,
            'code': 'MUL_CAH',
            'previews': [
                {
                    'forme': 3,
                    'fond': 20,
                    'textcolor': 36,
                    'picto': 302,
                    'textes': [
                        {
                            'value': 'jdksqj',
                            'ratio': 1
                        }
                    ],
                    'font': 14,
                    'pack': null
                },
                {
                    'forme': 3,
                    'fond': 290,
                    'textcolor': 12,
                    'picto': 315,
                    'textes': [
                        {
                            'value': 'fjq kfjsdkf kj kj',
                            'ratio': 1
                        }
                    ],
                    'font': 14,
                    'pack': null
                },
                {
                    'forme': 3,
                    'fond': 21,
                    'textcolor': 36,
                    'picto': 298,
                    'textes': [
                        {
                            'value': 'jfk jsfkjsdkfj k',
                            'ratio': 1
                        }
                    ],
                    'font': 14,
                    'pack': null
                },
                {
                    'forme': 3,
                    'fond': 289,
                    'textcolor': 12,
                    'picto': 308,
                    'textes': [
                        {
                            'value': 'jfkdsj fkjkfdsj ',
                            'ratio': 1
                        }
                    ],
                    'font': 14,
                    'pack': null
                },
                {
                    'forme': 3,
                    'fond': 22,
                    'textcolor': 36,
                    'picto': 299,
                    'textes': [
                        {
                            'value': 'jfk dsjkfj kfdjs k',
                            'ratio': 1
                        }
                    ],
                    'font': 14,
                    'pack': null
                },
                {
                    'forme': 3,
                    'fond': 89,
                    'textcolor': 36,
                    'picto': 300,
                    'textes': [
                        {
                            'value': 'jfkdjskfjksdfksdfksdjf',
                            'ratio': 0.95
                        }
                    ],
                    'font': 14,
                    'pack': null
                },
                {
                    'forme': 3,
                    'fond': 288,
                    'textcolor': 12,
                    'picto': 311,
                    'textes': [
                        {
                            'value': 'jfk djskfjskdfjk ',
                            'ratio': 1
                        }
                    ],
                    'font': 14,
                    'pack': null
                },
                {
                    'forme': 3,
                    'fond': 90,
                    'textcolor': 12,
                    'picto': 301,
                    'textes': [
                        {
                            'value': 'jfkdsjfksdjfkj',
                            'ratio': 1
                        }
                    ],
                    'font': 14,
                    'pack': null
                },
                {
                    'forme': 3,
                    'fond': 287,
                    'textcolor': 12,
                    'picto': 312,
                    'textes': [
                        {
                            'value': 'kfjksdfjksfjskfjk',
                            'ratio': 1
                        }
                    ],
                    'font': 14,
                    'pack': null
                },
                {
                    'forme': 3,
                    'fond': 91,
                    'textcolor': 36,
                    'picto': 309,
                    'textes': [
                        {
                            'value': 'jkfjdskfjskfjk',
                            'ratio': 1
                        }
                    ],
                    'font': 14,
                    'pack': null
                }
            ]
        }
    },
];

// ==============================================================================================================
// TOGGLE OUVERTURE Cmon_preview_option
// ==============================================================================================================

const optionsTextarea = document.querySelector('#options');

document.querySelector('#product_addtocart_form label[for="options"]').addEventListener('click', function() {
    optionsTextarea.style.display = optionsTextarea.style.display === 'none' ? 'block' : 'none';
});

// ==============================================================================================================
// AJOUT AU PANIER
// ==============================================================================================================

document.querySelector('#product_addtocart_form').addEventListener('submit', function(e) {
    // pour le debug, on empêche l'envoi du form
    // (ne pas faire ça sur l'appli magento)
    e.preventDefault();
    console.log('[CMON] Demande de validation des options du produit...');
    // diffusion d'un event personnalisé qui sera capté par l'appli React
    const event = new CustomEvent('cmon:validateProductOptions', {detail: {originalEvent:e}});
    document.dispatchEvent(event);
    return false;
});

// ==============================================================================================================
// AFFICHAGE PREVIEWS DU PANIER
// ==============================================================================================================

const cartItemsSrc = document.querySelector('#cartItems');
cartItemsSrc.value = JSON.stringify(cartItems, null, 4);

function renderCart(items) {
    const placeholders = [];

    items.forEach( function(item) {
        placeholders.push(`<div class="preview-placeholder" data-itemid="${item.id}">&nbsp;</div>`);
    });

    document.querySelector('#mini-cart').innerHTML = placeholders.join('');
}

renderCart(cartItems);

document.querySelector('#dispatchCartUpdated').addEventListener('click', function() {
    if (cartItems.length) {
        // vérification si les éléments sont présents dans la page
        checkForPlaceholders();
    } else {
        console.log('[CMON] Cart vide...');
    }
});

window.requestAnimationFrame = window.requestAnimationFrame || window.mozRequestAnimationFrame ||
    window.webkitRequestAnimationFrame || window.msRequestAnimationFrame;

function checkForPlaceholders() {
    const targets = document.querySelectorAll('.preview-placeholder:not(.rendered)');
    if (targets && targets.length && cartItems.length) {
        console.log('[CMON] La page contient des placeholders non-rendus.');
        dispatchToApp('cmon:updatePagePreviews', cartItems, false);
    }
    //requestAnimationFrame(checkForPlaceholders);
}

//requestAnimationFrame(checkForPlaceholders);

// diffusion de l'event à l'appli React
function dispatchToApp(type, items, debug=false) {
    if (items.length) {
        var previewItems = items.map( function(item) {
            var itemId = parseInt(item.id, 10);
            return {
                id: itemId,
                // on récupère tous les preview-placeholder de la page correspondant
                // à l'id de l'item du panier (attribut data-itemid)
                targets: item === null ? null : document.querySelectorAll('[data-itemid="'+itemId+'"]'),
                item: item === null ? null : item.value//JSON.parse(item.options[0].print_value),
            };
        });

        //console.log('cartItems', cartItems);

        // diffusion d'un event personnalisé qui sera capté par l'appli React
        // noter la propriété detail : custom data
        var event = new CustomEvent(type, {detail: {previewItems:previewItems}});
        document.dispatchEvent(event);

        if (debug) {
            console.log(JSON.stringify(items, null, '\t'));
        }
    }
}

// ==============================================================================================================
// AFFICHAGE PREVIEWS DE LA PAGE
// ==============================================================================================================

document.addEventListener('DOMContentLoaded', function() {
    const items = [
        {
            'id': 104,
            'value':{
                'id': 3,
                'code': 'VAR_EAO',
                'previews': [
                    {
                        'fond': 292,
                        'forme': 3,
                        'font': 12,
                        'picto': 372,
                        'textcolor': 15,
                        'textes': [
                            {
                                'value': 'Preview de la page',
                                'ratio': 1
                            }
                        ],
                        'pack': null
                    }
                ]
            }
        },
        {
            'id': 105,
            'value': {
                'id': 14,
                'code': 'OBJ_BOX',
                'previews': [
                    {
                        'fond': 295,
                        'forme': 13,
                        'font': 13,
                        'picto': 105,
                        'textcolor': 89,
                        'textes': [
                            {
                                'value': 'Preview de la page',
                                'ratio': 0.85
                            }
                        ],
                        'pack': null
                    }
                ]
            }
        }
    ]
    dispatchToApp('cmon:updatePagePreviews', items, false);
});

// ========================================================================================================
// Ecoute de l'event 'cmon:previewsRendered' diffusé par l'app

// on écoute l'event sur window
/*window.addEventListener('cmon:previewsRendered', function(e) {

    // on récupère les placeholders rendered de la page
    var placeholders = document.querySelectorAll('.preview-placeholder.rendered');

    // obligé de faire un setTimeout pour attendre le rendu de la frame
    // et récupérer les dimensions des éléments
    setTimeout(function() {
        // on boucle sur la nodelist pour récupérer les infos de taille
        [].map.call(placeholders, target => {
            console.log(target, target.offsetWidth, target.offsetHeight);
        });
    }, 0); // je mets 0 ms, mettre plus si il y'a problème


});*/

// on écoute l'event sur window **en NATIF** (car event natif, pas jQuery)
/*window.addEventListener('cmon:previewsRendered', function(e) {

    // ici, on peut utiliser jQuery
    var $placeholders = $('.preview-placeholder.rendered');

    if ($placeholders.length) {
        setTimeout(function() {
            $placeholders.forEach(function(index, item) {
                console.log(item, $(item).width(), $(item).height());
            });
        }, 0);
    }

});*/

window.addEventListener('cmon:packBoxOptionChanged', function(e) {
    console.log('sacSelected', e.detail.sacSelected);
});

window.addEventListener('cmon:firstInteractionWithProduct', function(e) {
    console.log('firstInteractionWithProduct', e);
});


window.addEventListener('cmon:priceVariation', function(e) {
    console.log('cmon:priceVariation', e.detail);
});